import Model from"./model.js";import showMessage from"./message.js";import randomSelection from"./utils.js";import tools from"./tools.js";function loadWidget(e){const t=new Model(e);function o(e){let t,o,i=!1,s=e.message.default;window.addEventListener("mousemove",(()=>i=!0)),window.addEventListener("keydown",(()=>i=!0)),setInterval((()=>{i?(i=!1,clearInterval(t),t=null):t||(t=setInterval((()=>{showMessage(s,6e3,9)}),2e4))}),1e3),showMessage(function(e){if("/"===location.pathname)for(let{hour:t,text:o}of e){const e=new Date,i=t.split("-")[0],s=t.split("-")[1]||i;if(i<=e.getHours()&&e.getHours()<=s)return o}const t=`欢迎阅读<span>「${document.title.split(" - ")[0]}」</span>`;let o;if(""!==document.referrer){const e=new URL(document.referrer),i=e.hostname.split(".")[1],s={baidu:"百度",so:"360搜索",google:"谷歌搜索"};return location.hostname===e.hostname?t:(o=i in s?s[i]:e.hostname,`Hello！来自 <span>${o}</span> 的朋友<br>${t}`)}return t}(e.time),7e3,11),window.addEventListener("mouseover",(t=>{for(let{selector:i,text:s}of e.mouseover)if(t.target.closest(i)){if(o===i)return;return o=i,s=randomSelection(s),s=s.replace("{text}",t.target.innerText),void showMessage(s,4e3,8)}})),window.addEventListener("click",(t=>{for(let{selector:o,text:i}of e.click)if(t.target.closest(o))return i=randomSelection(i),i=i.replace("{text}",t.target.innerText),void showMessage(i,4e3,8)})),e.seasons.forEach((({date:e,text:t})=>{const o=new Date,i=e.split("-")[0],n=e.split("-")[1]||i;i.split("/")[0]<=o.getMonth()+1&&o.getMonth()+1<=n.split("/")[0]&&i.split("/")[1]<=o.getDate()&&o.getDate()<=n.split("/")[1]&&(t=(t=randomSelection(t)).replace("{year}",o.getFullYear()),s.push(t))}));const n=()=>{};console.log("%c",n),n.toString=()=>{showMessage(e.message.console,6e3,9)},window.addEventListener("copy",(()=>{showMessage(e.message.copy,6e3,9)})),window.addEventListener("visibilitychange",(()=>{document.hidden||showMessage(e.message.visibilitychange,6e3,9)}))}localStorage.removeItem("waifu-display"),sessionStorage.removeItem("waifu-text"),document.body.insertAdjacentHTML("beforeend",'<div id="waifu">\n            <div id="waifu-tips"></div>\n            <canvas id="live2d" width="800" height="800"></canvas>\n            <div id="waifu-tool"></div>\n        </div>'),setTimeout((()=>{document.getElementById("waifu").style.bottom=0}),0),function(){tools["switch-model"].callback=()=>t.loadOtherModel(),tools["switch-texture"].callback=()=>t.loadRandModel(),Array.isArray(e.tools)||(e.tools=Object.keys(tools));for(let t of e.tools)if(tools[t]){const{icon:e,callback:o}=tools[t];document.getElementById("waifu-tool").insertAdjacentHTML("beforeend",`<span id="waifu-tool-${t}">${e}</span>`),document.getElementById("waifu-tool-"+t).addEventListener("click",o)}}(),function(){let i=localStorage.getItem("modelId"),s=localStorage.getItem("modelTexturesId");null===i&&(i=1,s=53),t.loadModel(i,s),fetch(e.waifuPath).then((e=>e.json())).then(o)}()}function initWidget(e,t){"string"==typeof e&&(e={waifuPath:e,apiPath:t}),document.body.insertAdjacentHTML("beforeend",'<div id="waifu-toggle">\n            <span>看板娘</span>\n        </div>');const o=document.getElementById("waifu-toggle");o.addEventListener("click",(()=>{o.classList.remove("waifu-toggle-active"),o.getAttribute("first-time")?(loadWidget(e),o.removeAttribute("first-time")):(localStorage.removeItem("waifu-display"),document.getElementById("waifu").style.display="",setTimeout((()=>{document.getElementById("waifu").style.bottom=0}),0))})),localStorage.getItem("waifu-display")&&Date.now()-localStorage.getItem("waifu-display")<=864e5?(o.setAttribute("first-time",!0),setTimeout((()=>{o.classList.add("waifu-toggle-active")}),0)):loadWidget(e)}export default initWidget;